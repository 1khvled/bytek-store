# üîç Debug Email Notification Issue

## ‚úÖ What We Know Works

1. **Function works when called directly** ‚úÖ
   - Tested and got: "Email notification sent successfully"
   - Secrets are set correctly (RESEND_API_KEY, ADMIN_EMAIL, APP_URL)

2. **Function code is correct** ‚úÖ
   - Has CORS headers
   - Accepts POST requests
   - Logs everything

## ‚ùì What Might Be Wrong

The trigger might not be firing or the HTTP call is failing silently.

## üîß Step-by-Step Debugging

### Step 1: Verify Trigger Exists

Run this in **Supabase SQL Editor**:

```sql
-- Check if trigger exists
SELECT 
    tgname as trigger_name,
    tgrelid::regclass as table_name,
    tgenabled as enabled
FROM pg_trigger 
WHERE tgname = 'notify_admin_on_new_order';
```

**Expected**: Should return 1 row with `enabled = 'O'` (enabled)

**If no rows**: The trigger wasn't created. Run the migration again.

### Step 2: Verify Function Exists

```sql
-- Check if function exists
SELECT 
    proname as function_name
FROM pg_proc 
WHERE proname = 'notify_admin_new_order';
```

**Expected**: Should return 1 row

### Step 3: Test Trigger Manually

Run this in **Supabase SQL Editor** to test the trigger:

```sql
-- Insert a test order (this should trigger email)
INSERT INTO public.orders (
    customer_name,
    customer_phone,
    customer_email,
    customer_address,
    wilaya_name,
    total,
    items,
    status
) VALUES (
    'Trigger Test User',
    '123456789',
    'test@test.com',
    'Test Address',
    'Algiers',
    1000,
    '[{"name": "Test Product", "quantity": 1, "price": 1000}]'::jsonb,
    'pending'
) RETURNING id, order_number;
```

**Check**:
1. Did the order get inserted? (Should see id and order_number)
2. Check your email: khvled2004@gmail.com
3. Check function logs: https://supabase.com/dashboard/project/ysmooabkfrnuawdqpvxt/functions/notify-admin-order/logs

### Step 4: Check Function Logs

1. Go to: https://supabase.com/dashboard/project/ysmooabkfrnuawdqpvxt/functions/notify-admin-order/logs
2. Look for:
   - `=== EDGE FUNCTION CALLED ===` (means trigger called it)
   - `‚úÖ SUCCESS` (means email was sent)
   - `‚ùå ERROR` (means something failed)

**If you see "EDGE FUNCTION CALLED"**: Trigger is working, check Resend/email
**If you DON'T see "EDGE FUNCTION CALLED"**: Trigger is not firing

### Step 5: Check Database Logs

In Supabase SQL Editor, check for warnings:

```sql
-- This won't show historical logs, but you can check if pg_net is working
SELECT * FROM net.http_request_queue 
ORDER BY created_at DESC 
LIMIT 10;
```

### Step 6: Verify pg_net Extension

```sql
-- Check if pg_net extension is enabled
SELECT * FROM pg_extension WHERE extname = 'pg_net';
```

**Expected**: Should return 1 row

## üö® Common Issues

### Issue 1: Trigger Not Created
**Solution**: Run the migration again:
1. Go to SQL Editor
2. Copy `supabase/migrations/20251230000001_notify_admin_on_order.sql`
3. Paste and run

### Issue 2: pg_net Not Working
**Solution**: The extension might not be enabled. The migration should handle this, but if not:

```sql
CREATE EXTENSION IF NOT EXISTS pg_net;
```

### Issue 3: Order Missing Required Fields
**Solution**: Make sure the order has all required fields:
- `id` (auto-generated)
- `order_number` (auto-generated by trigger)
- `customer_name`
- `customer_phone`
- `customer_address`
- `wilaya_name`
- `total`
- `items` (JSONB)
- `created_at` (auto-generated)

### Issue 4: Email Going to Spam
**Solution**: 
1. Check spam folder
2. Check Resend dashboard: https://resend.com/emails
3. Verify email address: khvled2004@gmail.com

## üß™ Quick Test Script

Run this in PowerShell to test everything:

```powershell
# Test 1: Function directly (we know this works)
$anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzbW9vYWJrZnJudWF3ZHFwdnh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjc5MTMsImV4cCI6MjA4MjYwMzkxM30.uMcWOV_wOXRpsfHxvVuzhU8D4H6VAlyfSHQ5YDNikBk"
$testOrder = @{
    order = @{
        id = "test-$(Get-Date -Format 'yyyyMMddHHmmss')"
        order_number = "TEST-$(Get-Date -Format 'yyyyMMddHHmmss')"
        customer_name = "PowerShell Test"
        customer_phone = "5551234"
        customer_email = "test@example.com"
        customer_address = "Test Address"
        wilaya_name = "Algiers"
        total = 5000
        items = @(@{
            name = "Test Item"
            quantity = 2
            price = 2500
        })
        created_at = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
    }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "https://ysmooabkfrnuawdqpvxt.supabase.co/functions/v1/notify-admin-order" `
    -Method POST `
    -Headers @{
        "Authorization" = "Bearer $anonKey"
        "Content-Type" = "application/json"
    } `
    -Body $testOrder
```

**If this works**: Function is fine, issue is with trigger
**If this fails**: Check function logs for errors

## üìã Next Steps

1. **Run Step 1-3 above** to verify trigger exists and test it
2. **Check function logs** after placing an order
3. **Check Resend dashboard** to see if emails are being sent
4. **Share results** and I'll help fix the specific issue

